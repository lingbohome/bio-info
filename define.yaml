apiVersion: v1
kind: ConfigMap
metadata:
  name: bio-qc-sample
  namespace: shipper-platform
  labels:
    shipper.lingbohome.com/managed: "true"
    shipper.lingbohome.com/templated-by: "builder"
    template.shipper.lingbohome.com/version: "0.1.0"
  annotations:
    kubesphere.io/alias-name: 生信分析
    kubesphere.io/creator: system
    kubesphere.io/description: "基于用户输入的样本集分析"
    cert.shipper.lingbohome.com/scope: "oss,ssh"
data:
  template.yaml: |
    apiVersion: tekton.dev/v1
    kind: PipelineRun
    metadata:
      annotations:
        tekton.dev/displayName: Shipper-Bio-QC-Sample
        tekton.dev/pipelines.minVersion: 0.17.0
        tekton.dev/platforms: linux/amd64
        tekton.dev/tags: bio
      generateName: baesd-shipper
      labels:
        app.kubernetes.io/version: '0.3'
        shipper.lingbohome.com/platform: shipper
        shipper.lingbohome.com/useFor: builder
    spec:
      params:
        - name: SOURCE_URL
          value: {{ .Values.sourceUrl }}
        - name: SOURCE_REFERENCE
          value: {{ .Values.sourceRef | default "" | quote }}           
        - name: R1_Fastq_File
          value: {{ .Values.r1FastqFile | default "./R1_Fastq_File" }}
        - name: R2_Fastq_File
          value: {{ .Values.r2FastqFile | default "./R2_Fastq_File" }}                      
        - name: Sample_Name
          value: {{ .Values.sampleName | default .Release.PipelineName | quote }}
        - name: Output_Directory
          value: {{ .Values.outputDir | default "/tmp" | quote }}
        - name: AlnTarget
          value: {{ .Values.alnTarget | quote }}                  
      pipelineSpec:
        description: bio qc sample pipeline..
        params:
          - description: A git repo url.
            name: SOURCE_URL
            type: string
          - default: ''
            description: The branch, tag or SHA to checkout.
            name: SOURCE_REFERENCE
            type: string                    
          - default: ./R1_Fastq_File
            description: R1 fastq file.
            name: R1_Fastq_File
            type: string
          - default: ./R2_Fastq_File
            description: R2 fastq file.
            name: R2_Fastq_File
            type: string
          - description: Sample name.
            name: Sample_Name
            type: string 
          - default: /home
            description: Output directory.
            name: Output_Directory
            type: string
          - name: AlnTarget
            type: string                          
        tasks:
          - name: fetch-from-git
            params:
              - name: url
                value: $(params.SOURCE_URL)
              - name: revision
                value: $(params.SOURCE_REFERENCE)
              - name: sslVerify
                value: 'false'
              - name: subdirectory
                value: '{{ .Release.BuilderName }}/00_inputs/'
            taskRef:
              resolver: bundles
              params:
              - name: bundle
                value: hub.cloud.lingbohome.com/shipper/tkn-artifacts/catalog/builtin:0.1
              - name: name
                value: git-clone
              - name: kind
                value: task            
            workspaces:
              - name: output
                workspace: source-ws
              - name: ssh-directory
                workspace: sshkey-ws        
          - name: bio-qc
            params:
              - name: R1_Fastq_File
                value: $(params.R1_Fastq_File)
              - name: R2_Fastq_File
                value: $(params.R2_Fastq_File)
              - name: Sample_Name
                value: $(params.Sample_Name)
              - name: Output_Directory
                value: $(params.Output_Directory)
            runAfter:
              - fetch-from-git                          
            workspaces:
              - name: source
                workspace: source-ws            
            taskSpec:
              description: qc sample task.
              params:
                - default: ./R1_Fastq_File
                  description: R1 fastq file.
                  name: R1_Fastq_File
                  type: string
                - default: ./R2_Fastq_File
                  description: R2 fastq file.
                  name: R2_Fastq_File
                  type: string
                - description: Sample name.
                  name: Sample_Name
                  type: string 
                - default: /home
                  description: Output directory.
                  name: Output_Directory
                  type: string                                                                                                             
              workspaces:
                - description: data source
                  name: source                                                    
              steps:            
                - computeResources: {}
                  env:
                    - name: PARAM_INPUT
                      value: "{{ .Release.BuilderName }}/00_inputs"
                    - name: PARAM_STEP_NAME
                      value: "01_QC"                       
                    - name: PARAM_SUBWORKDIR
                      value: "{{ .Release.BuilderName }}/$(PARAM_STEP_NAME)/$(params.Sample_Name)"                                    
                  image: registry.cn-shanghai.aliyuncs.com/bio-cloud/bioinfo-qc:v0.3.2
                  name: sample-qc
                  args:
                    - '-f$(workspaces.source.path)/$(PARAM_INPUT)/$(params.R1_Fastq_File)'
                    - '-r$(workspaces.source.path)/$(PARAM_INPUT)/$(params.R2_Fastq_File)'
                    - '-p$(params.Sample_Name)' 
                    - '-o$(workspaces.source.path)/$(PARAM_SUBWORKDIR)'                                      
                  script: |
                    #!/usr/bin/env bash
                    set -e

                    while getopts f:r:p:o: opt
                    do
                        case $opt in
                            f)
                            r1_fq=$OPTARG
                            ;;
                            r)
                            r2_fq=$OPTARG
                            ;;
                            p)
                            sampleID=$OPTARG
                            ;;
                            o)
                            echo "output args >>>> ${OPTARG}"
                            outDir=$OPTARG
                            ;;
                        esac
                    done

                    ## 准备qc工作目录及输出目录
                    echo "output >>>> ${outDir}"
                    mkdir -p ${outDir}

                    export TRIMMOMATIC=/usr/local/bin/Trimmomatic-0.36/trimmomatic-0.36.jar
                    export ADAPTER=$(workspaces.source.path)/$PARAM_INPUT/TruSeq3-PE-2.fa
                    
                    echo "*** QC by FastQC-v0.11.5 and Trimmomatic-0.36 ***"
                    echo "Begin at:" `date`
                    $FASTQC -t 8 -o $outDir $r1_fq $r2_fq
                    unzip -d $outDir $outDir/${sampleID}_R1*_fastqc.zip
                    unzip -d $outDir $outDir/${sampleID}_R2*_fastqc.zip
                    cp $outDir/${sampleID}_R1*_fastqc/fastqc_data.txt $outDir/$sampleID.R1.fastqc_data.txt
                    cp $outDir/${sampleID}_R2*_fastqc/fastqc_data.txt $outDir/$sampleID.R2.fastqc_data.txt
                    rm -rf $outDir/${sampleID}_R1*_fastqc $outDir/${sampleID}_R2*_fastqc
                    java -jar $TRIMMOMATIC PE -threads 6 -phred33 $r1_fq $r2_fq $outDir/$sampleID.R1_clean.fq.gz $outDir/$sampleID.R1_unpaired.fq.gz $outDir/$sampleID.R2_clean.fq.gz $outDir/$sampleID.R2_unpaired.fq.gz ILLUMINACLIP:$ADAPTER:2:30:10:8:true LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:72
                    echo "End at:" `date`
                    echo "*** Finished QC by FastQC-v0.11.5 and Trimmomatic-0.36 ***"
                    ls -l ${outDir}
          - name: bio-aln
            params:
              - name: Sample_Name
                value: $(params.Sample_Name)
              - name: AlnTarget
                value: $(params.AlnTarget)
            runAfter:
              - bio-qc                          
            workspaces:
              - name: source
                workspace: source-ws            
            taskSpec:
              description: aln sample task.
              params:
                - description: Sample name.
                  name: Sample_Name
                  type: string 
                - name: AlnTarget
                  type: string                                                                                                             
              workspaces:
                - description: data source
                  name: source                                                    
              steps:            
                - computeResources: {}
                  env:
                    - name: PARAM_INPUT
                      value: "{{ .Release.BuilderName }}/00_inputs"
                    - name: PARAM_STEP_NAME
                      value: "02_aln"                      
                    - name: PARAM_01QCDIR
                      value: "{{ .Release.BuilderName }}/01_QC/$(params.Sample_Name)"
                    - name: PARAM_SUBWORKDIR
                      value: "{{ .Release.BuilderName }}/$(PARAM_STEP_NAME)/$(params.Sample_Name)"                                        
                  image: registry.cn-shanghai.aliyuncs.com/bio-cloud/bioinfo-aln:v0.2
                  name: sample-aln
                  args:
                    - '-f$(workspaces.source.path)/$(PARAM_01QCDIR)/$(params.Sample_Name).R1_clean.fq.gz'
                    - '-r$(workspaces.source.path)/$(PARAM_01QCDIR)/$(params.Sample_Name).R2_clean.fq.gz'
                    - '-p$(params.Sample_Name)'
                    - '-t$(workspaces.source.path)/$(PARAM_INPUT)/$(params.AlnTarget)'  
                    - '-o$(workspaces.source.path)/$(PARAM_SUBWORKDIR)'                                      
                  script: |
                    #!/usr/bin/env bash
                    set -e

                    while getopts f:r:p:t:o: opt
                    do
                        case $opt in
                            f)
                            r1_fq=$OPTARG
                            ;;
                            r)
                            r2_fq=$OPTARG
                            ;;
                            p)
                            sampleID=$OPTARG
                            ;;
                            t)
                            target=$OPTARG
                            ;;
                            o)
                            outDir=$OPTARG
                            ;;
                        esac
                    done

                    ## 准备aln工作目录及输出目录
                    echo "output >>>> ${outDir}"
                    mkdir -p $outDir

                    ##设置环境变量
                    export SOFT=/data1/workdir/software
                    export SAMTOOLS_1_8=$SOFT/samtools-1.8/bin/samtools
                    export REF="$(workspaces.source.path)/index_files_retry/human_g1k_v37.fasta"
                    ######例子
                    ####   sh /home/wangce/workdir/bin/ctDNA_v5/aln_ctDNA.sh  -f /data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/01_QC/202411_CL02080.R1_clean.fq.gz  -r /data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/01_QC/202411_CL02080.R2_clean.fq.gz  -t /home/wangce/workdir/database/humandb/panel/338genes_20210624.bed  -p 202411_CL02080  -o /data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/02_aln  >>/data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/scriptLog/02_aln_202411_CL02080.o  2>>/data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/scriptLog/02_aln_202411_CL02080.e
                    echo "Begin at:" `date`
                    echo "*** Alignment by BWA-0.7.12-r1039 ***"
                    cd $(workspaces.source.path)/index_files
                    # bwa index -p human_g1k_v37 -b 1000000000 -a bwtsw $(workspaces.source.path)/index_files/human_g1k_v37.fasta.gz
                    # bwa index -p human_g1k_v37 $outDir/human_g1k_v37.fasta.gz
                    cd $(workspaces.source.path)
                    bwa mem -R "@RG\tID:$sampleID\tSM:$sampleID\tPL:illumina\tDS:hg19\tCN:clgene" -t 8 -M $REF $r1_fq $r2_fq > $outDir/$sampleID.bam
                    ## bwa mem -R "@RG\tID:$sampleID\tSM:$sampleID\tPL:illumina\tDS:hg19\tCN:clgene" -t 8 -M ./index_files/human_g1k_v37 ./01_QC/FA240915059.R1_clean.fq.gz ./01_QC/FA240915059.R2_clean.fq.gz $r2_fq > ./02_aln/$sampleID.bam
                    echo "*** Finished alignment by BWA-0.7.12-r1039 ***"
                    echo "*** Bam sorting by samtools-v1.8 ***"
                    $SAMTOOLS_1_8 sort -m 4G -@ 8 -T $outDir/$sampleID.sort -o $outDir/$sampleID.sort.bam $outDir/$sampleID.bam
                    if [ -f "$outDir/$sampleID.sort.bam" ];then
                      $SAMTOOLS_0_1_19 index $outDir/$sampleID.sort.bam
                      rm $outDir/$sampleID.bam
                    fi
                    echo "*** Finished sorting bam by samtools-v1.8 ***"
                    echo "*** Target region filter by samtools-v0.1.19 ***"
                    $SAMTOOLS_0_1_19 view -b -@ 8 -q 30 -L $target -o $outDir/$sampleID.target.bam $outDir/$sampleID.sort.bam
                    $SAMTOOLS_0_1_19 index $outDir/$sampleID.target.bam
                    echo "*** Finished target region filter by samtools-v0.1.19 ***"
                    echo "End at:" `date`

                    ls -l $outDir
                - computeResources: {}
                  env:
                    - name: PARAM_INPUT
                      value: "{{ .Release.BuilderName }}/00_inputs"
                    - name: PARAM_STEP_NAME
                      value: "02_aln_post"
                    - name: PARAM_OUTPUT_DIR
                      value: "03_var"                                            
                    - name: PARAM_02ALNDIR
                      value: "{{ .Release.BuilderName }}/02_aln/$(params.Sample_Name)"
                    - name: PARAM_SUBWORKDIR
                      value: "{{ .Release.BuilderName }}/$(PARAM_OUTPUT_DIR)/$(params.Sample_Name)"                                        
                  image: registry.cn-shanghai.aliyuncs.com/bio-cloud/bioinfo-aln:v0.2
                  name: sample-aln-post
                  args:
                    - '-b$(workspaces.source.path)/$(PARAM_02ALNDIR)/$(params.Sample_Name).sort.bam'
                    - '-m$(workspaces.source.path)/$(PARAM_INPUT)/$(params.AlnTarget)'
                    - '-p$(params.Sample_Name)'
                    - '-t$(workspaces.source.path)/$(PARAM_INPUT)/$(params.AlnTarget)'  
                    - '-o$(workspaces.source.path)/$(PARAM_SUBWORKDIR)'                                      
                  script: |
                    #!/usr/bin/env bash
                    set -e

                    while getopts b:t:m:p:o: opt
                    do
                        case $opt in
                            b)
                            bam=$OPTARG
                            ;;
                            t)
                            target=$OPTARG
                            ;;
                            m)
                            medicineDir=$OPTARG
                            ;;
                            p)
                            sampleID=$OPTARG
                            ;;
                            o)
                            outDir=$OPTARG
                            ;;
                        esac
                    done

                    ## 准备aln_post工作目录及输出目录
                    echo "output >>>> ${outDir}"
                    mkdir -p $outDir

                    ##设置环境变量
                    export SOFT=/data1/workdir/software
                    export SAMTOOLS_1_8=$SOFT/samtools-1.8/bin/samtools
                    export REF="$(workspaces.source.path)/index_files_retry/human_g1k_v37.fasta"
                    ###例子
                    ### sh /home/wangce/workdir/bin/ctDNA_v5/snvIndel_calling_ctDNA_v2.sh  -t /data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/02_aln/202411_CL02080.rmdup.target.bam  -l /home/wangce/workdir/database/humandb/panel/338genes_20210624.bed  -c /home/wangce/workdir/database/humandb/ctDNA_report/pon/panel338_Mutect2_2021/vcf/40samples.pon.vcf.gz  -p 202411_CL02080  -o /data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/03_var  >>/data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/scriptLog/03_snvInDel_calling_202411_CL02080.o  2>>/data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/scriptLog/03_snvInDel_calling_202411_CL02080.e
                    echo "*** Post alignment process by gencore-v0.14.0, picard-2.20.0 and samtools-v0.1.19 ***"
                    echo "Begin at:" `date`
                    {
                        ##### Generate consensus reads to reduce sequencing noises and remove duplications 
                        $GENCORE -i $bam -o $outDir/$sampleID.rmdup.unsorted.bam -r $REF -a 0.7 -j $outDir/$sampleID.report.json -h $outDir/$sampleID.report.html
                        echo "sort bam ...."
                        ##### Sort bam
                        $SAMTOOLS_1_8 sort -m 4G -@ 4 -T $outDir/$sampleID.rmdup -o $outDir/$sampleID.rmdup.bam $outDir/$sampleID.rmdup.unsorted.bam
                        $SAMTOOLS_1_8 index $outDir/$sampleID.rmdup.bam
                        ##### Remove bam
                        rm $outDir/$sampleID.rmdup.unsorted.bam
                        ##### Target bam
                        $SAMTOOLS_1_8 view -b -@ 4 -L $target -o $outDir/$sampleID.rmdup.target.bam $outDir/$sampleID.rmdup.bam
                        $SAMTOOLS_1_8 index $outDir/$sampleID.rmdup.target.bam
                    } &
                    {
                        ##### Remove duplicate reads
                        java -Xmx16g -jar $PICARD MarkDuplicates I=$bam O=$outDir/$sampleID.sv_rmdup.bam M=$outDir/$sampleID.sv_rmdup.metrix VALIDATION_STRINGENCY=LENIENT REMOVE_DUPLICATES=true
                        $SAMTOOLS_1_8 index $outDir/$sampleID.sv_rmdup.bam
                        ##### Target bam
                        #$SAMTOOLS_1_8 view -b -@ 4 -L $medicineDir -o $outDir/$sampleID.sv_rmdup.sv_target.bam $outDir/$sampleID.sv_rmdup.bam
                        #$SAMTOOLS_1_8 index $outDir/$sampleID.sv_rmdup.sv_target.bam
                    } &
                    wait
                    echo "End at:" `date`
                    echo "*** Finished post alignment process by gencore-v0.14.0, picard-2.20.0 and samtools-v1.8 ***"

                    ls -l $outDir
                - computeResources: {}
                  env:
                    - name: PARAM_INPUT
                      value: "{{ .Release.BuilderName }}/00_inputs"
                    - name: PARAM_01QCDIR
                      value: "{{ .Release.BuilderName }}/01_QC/$(params.Sample_Name)"                      
                    - name: PARAM_02ALNDIR
                      value: "{{ .Release.BuilderName }}/02_aln/$(params.Sample_Name)"
                    - name: PARAM_03VARDIR
                      value: "{{ .Release.BuilderName }}/03_var/$(params.Sample_Name)"                                                                   
                    - name: PARAM_SUBWORKDIR
                      value: "{{ .Release.BuilderName }}/$(PARAM_STEP_NAME)/$(params.Sample_Name)"                                    
                  image: registry.cn-shanghai.aliyuncs.com/bio-cloud/bioinfo-qc-statistics:v0.2
                  name: qc-statistics                                     
                  script: |
                    #!/usr/bin/env bash
                    set -e
                    echo  -e "$(params.Sample_Name)\t$(workspaces.source.path)/$PARAM_02ALNDIR/$(params.Sample_Name).sort.bam\t$(workspaces.source.path)/$PARAM_03VARDIR/$(params.Sample_Name).rmdup.bam\t$(workspaces.source.path)/$PARAM_01QCDIR/$(params.Sample_Name).R1.fastqc_data.txt\t$(workspaces.source.path)/$PARAM_01QCDIR/$(params.Sample_Name).R2.fastqc_data.txt" >$(workspaces.source.path)/$PARAM_02ALNDIR/$(params.Sample_Name).bam_fastqc.list

                    perl /usr/local/bin/library_qc_ctDNA.pl  -l $(workspaces.source.path)/$PARAM_02ALNDIR/$(params.Sample_Name).bam_fastqc.list  -b $(workspaces.source.path)/$PARAM_INPUT/$(params.AlnTarget)  -p $(params.Sample_Name)  -o $(workspaces.source.path)/$PARAM_01QCDIR -S $SOFT/samtools-1.8/bin -B $SOFT/bedtools2/bin
                - computeResources: {}
                  env:
                    - name: PARAM_INPUT
                      value: "{{ .Release.BuilderName }}/00_inputs"
                    - name: PARAM_01QCDIR
                      value: "{{ .Release.BuilderName }}/01_QC/$(params.Sample_Name)"                      
                    - name: PARAM_02ALNDIR
                      value: "{{ .Release.BuilderName }}/02_aln/$(params.Sample_Name)"
                    - name: PARAM_03VARDIR
                      value: "{{ .Release.BuilderName }}/03_var/$(params.Sample_Name)"                                                                   
                    - name: PARAM_SUBWORKDIR
                      value: "{{ .Release.BuilderName }}/$(PARAM_STEP_NAME)/$(params.Sample_Name)"                                    
                  image: registry.cn-shanghai.aliyuncs.com/bio-cloud/bioinfo-random-seq-pick:v0.2.2
                  name: random-seq-pick                                     
                  script: |
                    #!/usr/bin/env bash
                    set -e
                    python3 /usr/local/bin/random_seq_pick.py  -i $(workspaces.source.path)/$PARAM_03VARDIR/$(params.Sample_Name).rmdup.target.bam  -s $(params.Sample_Name)  -n 1000000  -o $(workspaces.source.path)/$PARAM_02ALNDIR
                - computeResources: {}
                  env:
                    - name: PARAM_INPUT
                      value: "{{ .Release.BuilderName }}/00_inputs"
                    - name: PARAM_01QCDIR
                      value: "{{ .Release.BuilderName }}/01_QC/$(params.Sample_Name)"                      
                    - name: PARAM_02ALNDIR
                      value: "{{ .Release.BuilderName }}/02_aln/$(params.Sample_Name)"
                    - name: PARAM_03VARDIR
                      value: "{{ .Release.BuilderName }}/03_var/$(params.Sample_Name)"                                                                                                      
                  image: registry.cn-shanghai.aliyuncs.com/bio-cloud/bioinfo-msi:v0.4.1
                  name: msi
                  args:
                    - '-n$(workspaces.source.path)/$(PARAM_03VARDIR)/$(params.Sample_Name).rmdup.bam'
                    - '-t$(workspaces.source.path)/$(PARAM_02ALNDIR)/$(params.Sample_Name).rmdup.target.pickseq.bam'
                    - '-T$(workspaces.source.path)/$(PARAM_03VARDIR)/$(params.Sample_Name).rmdup.target.bam'                    
                    - '-b$(workspaces.source.path)/$(PARAM_INPUT)/$(params.AlnTarget)'
                    - '-r$(workspaces.source.path)/$(PARAM_INPUT)/reference.list_baseline'
                    - '-B$(workspaces.source.path)/$(PARAM_INPUT)/bed.txt'
                    - '-c$(workspaces.source.path)/$(PARAM_INPUT)/peaks.txt' 
                    - '-p$(params.Sample_Name)'
                    - '-o$(workspaces.source.path)/$(PARAM_03VARDIR)'                                                        
                  script: |
                    #!/usr/bin/env bash
                    set -e

                    while getopts n:t:T:b:r:B:c:p:o: opt
                    do
                        case $opt in
                            n)
                            normal_bam=$OPTARG
                            ;;
                            t)
                            tumor_pickseq_bam=$OPTARG
                            ;;
                            T)
                            tumor_bam=$OPTARG
                            ;;
                            b)
                            target=$OPTARG
                            ;;
                            r)
                            baseline_for_msisensor_pro=$OPTARG
                            ;;
                            B)
                            bed_for_msifinder=$OPTARG
                            ;;
                            c)
                            ctr_for_msifinder=$OPTARG
                            ;;
                            p)
                            sampleID=$OPTARG
                            ;;
                            o)
                            outDir=$OPTARG
                            ;;
                        esac
                    done

                    export REF="$(workspaces.source.path)/index_files_retry/human_g1k_v37.fasta"

                    echo "Begin at:" `date`
                    ## sleep 36000
                    echo "*** Analysis by MSIsensor (selected sites) ***"
                    $MSISENSOR msi -d $MS_V2 -n $normal_bam -t $tumor_pickseq_bam -e $target -o $outDir/$sampleID
                    msisensor_score=`cat $outDir/$sampleID | tail -1 | cut -f 3`
                    msisensor_judge=`echo "$msisensor_score > 70" | bc`
                    echo -e "MSIsensor_Status" > $outDir/$sampleID.msisensor
                    if [ $msisensor_judge -eq 1 ];then
                        echo -e "MSI" >> $outDir/$sampleID.msisensor
                    else
                        echo -e "MSS" >> $outDir/$sampleID.msisensor
                    fi
                    paste -d "\t" $outDir/$sampleID $outDir/$sampleID.msisensor > $outDir/$sampleID.msisensor.tmp
                    rm -rf $outDir/$sampleID.msisensor $outDir/$sampleID $outDir/${sampleID}_germline $outDir/${sampleID}_somatic $outDir/${sampleID}_dis

                    echo "*** Analysis by MSIsensor-pro ***"
                    ###加载动态库
                    export LD_LIBRARY_PATH=/data1/workdir/software/anaconda3/lib:$LD_LIBRARY_PATH
                    $MSISENSOR_PRO scan  -d $REF -o $outDir/$sampleID.reference.list
                    $MSISENSOR_PRO pro -d $outDir/$sampleID.reference.list -t $tumor_bam -o $outDir/$sampleID 2>$outDir/$sampleID.microsatellite.err 1>$outDir/$sampleID.microsatellite.log
                    # $MSISENSOR_PRO pro -d $baseline_for_msisensor_pro -t $tumor_bam -o $outDir/$sampleID
                    msisensor_pro_score=`cat $outDir/$sampleID | tail -1 | cut -f 3`
                    msisensor_pro_judge=`echo "$msisensor_pro_score > 20" | bc`
                    echo -e "MSIsensor-pro_Status" > $outDir/$sampleID.msisensor-pro
                    if [ $msisensor_pro_judge -eq 1 ];then
                        echo -e "MSI" >> $outDir/$sampleID.msisensor-pro
                    else
                        echo -e "MSS" >> $outDir/$sampleID.msisensor-pro
                    fi
                    paste -d "\t" $outDir/$sampleID $outDir/$sampleID.msisensor-pro > $outDir/$sampleID.msisensor-pro.tmp
                    rm -rf $outDir/$sampleID.msisensor-pro $outDir/$sampleID $outDir/${sampleID}_unstable $outDir/${sampleID}_all $outDir/${sampleID}_dis

                    echo "*** Analysis by MSIFinder ***"
                    python3 $MSIFINDER -fastahack $FASTAHACK -rf $REF -bam $tumor_bam -bed $bed_for_msifinder -ctr $ctr_for_msifinder -o $outDir/ -p $sampleID
                    mv $outDir/$sampleID.MSI.xls $outDir/$sampleID.msifinder.tmp
                    rm -rf $outDir/${sampleID}_MSIscore.xls

                    echo "*** Summary of results ***"
                    msisensor_result=`cat $outDir/$sampleID.msisensor.tmp | tail -1`
                    msisensor_pro_result=`cat $outDir/$sampleID.msisensor-pro.tmp | tail -1`
                    msifinder_score=`cat $outDir/$sampleID.msifinder.tmp |tail -1 | cut -f 2`
                    msifinder_judge=`cat $outDir/$sampleID.msifinder.tmp |tail -1 | cut -f 1`
                    rm -rf $outDir/$sampleID.msisensor.tmp $outDir/$sampleID.msisensor-pro.tmp $outDir/$sampleID.msifinder.tmp
                    counter=0
                    if [ $msisensor_judge -eq 1 ];then
                        counter=$((counter+1))
                    fi
                    if [ $msisensor_pro_judge -eq 1 ];then
                        counter=$((counter+1))
                    fi
                    if [ $msifinder_judge == "MSI-H" ];then
                        counter=$((counter+1))
                    fi
                    echo "Final MSI results: $counter of 3"
                    if [ $counter -ge 2 ];then
                        final_judge="MSI"
                    else
                        final_judge="MSS"
                    fi
                    echo -e "#Sample\tJudgement\tTotal_Sites(MSIsensor)\tUnstable_Sites(MSIsensor)\tUnstable_Ratio(MSIsensor)\tStatus(MSIsensor)\tTotal_Sites(MSIsensor-pro)\tUnstable_Sites(MSIsensor-pro)\tUnstable_Ratio(MSIsensor-pro)\tStatus(MSIsensor-pro)\tProba(MSIFinder)\tStatus(MSIFinder)" > $outDir/$sampleID.microsatellite.status.xls
                    echo -e "$sampleID\t$final_judge ($counter of 3)\t$msisensor_result\t$msisensor_pro_result\t$msifinder_score\t$msifinder_judge" >> $outDir/$sampleID.microsatellite.status.xls

                    echo "End at:" `date`                                                                                                                                                
        finally:
          - name: artifacts-producer
            params:
              - name: INPUTS_DIR_NAME
                value: "00_inputs"            
              - name: QC_STEP_NAME
                value: "01_QC"
              - name: ALN_STEP_NAME
                value: "02_aln"
              - name: VAR_DIR_NAME
                value: "03_var"
              - name: Sample_Name
                value: "$(params.Sample_Name)"
            workspaces:
              - name: source
                workspace: source-ws
            retries: 1                                                                                                                                                            
            taskSpec:
              description: |
                      A simple task that populates artifacts to TaskRun result
              params:
                - name: INPUTS_DIR_NAME              
                - name: QC_STEP_NAME
                - name: ALN_STEP_NAME
                - name: VAR_DIR_NAME                                              
                - name: Sample_Name                                      
              results:
                - description: artifact info.
                  name: ArtifactInfo
                  type: string
              workspaces:
                - description: data source
                  name: source                          
              steps:
                - name: emitting-artifacts
                  image: registry.cn-shanghai.aliyuncs.com/kube-shipper/mc:RELEASE.2024-10-08T09-37-26Z
                  script: |
                    #!/usr/bin/env bash
                    set -e

                    rm -rf  $(workspaces.source.path)/{{ .Release.BuilderName }}/$(params.INPUTS_DIR_NAME)/.git

                    usehttps={{- .Release.OSS.S3.UseHttps | default "false" }}
                    bucket={{ .Release.Workspace | default "bio-poc-data" }}
                    schema=http

                    if [ "$usehttps" = true ]; then
                        schema=https
                    fi

                    mc alias set oss $schema://{{- .Release.OSS.S3.Endpoint | default "minioserver.example.net" }} {{ .Release.OSS.S3.AccessKey }} {{ .Release.OSS.S3.SecretKey }} 
                    mc mb oss/$bucket  --ignore-existing

                    check_00_inputs_hash=sha256:$(find $(workspaces.source.path)/{{ .Release.BuilderName }}/$(params.INPUTS_DIR_NAME)/ -type f -exec sha256sum {} \; | sort -k 2 | sha256sum | awk '{print $1}')
                    mc cp --recursive $(workspaces.source.path)/{{ .Release.BuilderName }}/$(params.INPUTS_DIR_NAME)/ oss/$bucket/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.INPUTS_DIR_NAME)/

                    check_01_qc_hash=sha256:$(find $(workspaces.source.path)/{{ .Release.BuilderName }}/$(params.QC_STEP_NAME)/$(params.Sample_Name)/ -type f -exec sha256sum {} \; | sort -k 2 | sha256sum | awk '{print $1}')
                    mc cp --recursive $(workspaces.source.path)/{{ .Release.BuilderName }}/$(params.QC_STEP_NAME)/$(params.Sample_Name)/ oss/$bucket/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.QC_STEP_NAME)/$(params.Sample_Name)/

                    check_02_aln_hash=sha256:$(find $(workspaces.source.path)/{{ .Release.BuilderName }}/$(params.ALN_STEP_NAME)/$(params.Sample_Name)/ -type f -exec sha256sum {} \; | sort -k 2 | sha256sum | awk '{print $1}')
                    mc cp --recursive $(workspaces.source.path)/{{ .Release.BuilderName }}/$(params.ALN_STEP_NAME)/$(params.Sample_Name)/ oss/$bucket/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.ALN_STEP_NAME)/$(params.Sample_Name)/                     

                    check_03_var_hash=sha256:$(find $(workspaces.source.path)/{{ .Release.BuilderName }}/$(params.VAR_DIR_NAME)/$(params.Sample_Name)/ -type f -exec sha256sum {} \; | sort -k 2 | sha256sum | awk '{print $1}')
                    mc cp --recursive $(workspaces.source.path)/{{ .Release.BuilderName }}/$(params.VAR_DIR_NAME)/$(params.Sample_Name)/ oss/$bucket/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.VAR_DIR_NAME)/$(params.Sample_Name)/                    
                 
                    cat > $(results.ArtifactInfo.path) << EOF
                     {
                          "description":"生物分析结果集",
                          "outputs":[
                            {
                              "name":"00-inputs",
                              "producer":"data-source",
                              "type":"oss",
                              "format":"dir",
                              "url":"pkg:oss/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.INPUTS_DIR_NAME)?endpoint={{ .Release.OSS.S3.Endpoint }}&bucket={{ .Release.Workspace | default "bio-results" }}&usehttps={{- .Release.OSS.S3.UseHttps | default "false" }}&isdir=true",
                              "digest":"$check_00_inputs_hash",
                              "displayName":"{{ .Release.Workspace | default "bio-results" }}/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.INPUTS_DIR_NAME)",
                              "description":"$(params.INPUTS_DIR_NAME)"
                            },
                            {
                              "name":"01-qc",
                              "producer":"qc",
                              "type":"oss",
                              "format":"dir",
                              "url":"pkg:oss/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.QC_STEP_NAME)/$(params.Sample_Name)?endpoint={{ .Release.OSS.S3.Endpoint }}&bucket={{ .Release.Workspace | default "bio-results" }}&usehttps={{- .Release.OSS.S3.UseHttps | default "false" }}&isdir=true",
                              "digest":"$check_01_qc_hash",
                              "displayName":"{{ .Release.Workspace | default "bio-results" }}/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.QC_STEP_NAME)/$(params.Sample_Name)",
                              "description":"$(params.QC_STEP_NAME)"
                            },
                            {
                              "name":"02-aln",
                              "producer":"aln",
                              "type":"oss",
                              "format":"dir",
                              "url":"pkg:oss/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.ALN_STEP_NAME)/$(params.Sample_Name)?endpoint={{ .Release.OSS.S3.Endpoint }}&bucket={{ .Release.Workspace | default "bio-results" }}&usehttps={{- .Release.OSS.S3.UseHttps | default "false" }}&isdir=true",
                              "digest":"$check_02_aln_hash",
                              "displayName":"{{ .Release.Workspace | default "bio-results" }}/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.ALN_STEP_NAME)/$(params.Sample_Name)",
                              "description":"$(params.ALN_STEP_NAME)"
                            },
                            {
                              "name":"03-var",
                              "producer":"aln-post",
                              "type":"oss",
                              "format":"dir",
                              "url":"pkg:oss/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.VAR_DIR_NAME)/$(params.Sample_Name)?endpoint={{ .Release.OSS.S3.Endpoint }}&bucket={{ .Release.Workspace | default "bio-results" }}&usehttps={{- .Release.OSS.S3.UseHttps | default "false" }}&isdir=true",
                              "digest":"$check_03_var_hash",
                              "displayName":"{{ .Release.Workspace | default "bio-results" }}/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.VAR_DIR_NAME)/$(params.Sample_Name)",
                              "description":"$(params.VAR_DIR_NAME)"
                            }                     
                          ]
                      }                    
                    EOF
        results:
          - name: shipper-artifacts
            value: $(finally.artifacts-producer.results.ArtifactInfo)
        workspaces:
          - description: Location where source is stored.
            name: source-ws
          - name: sshkey-ws
            description: An optional workspace that allows providing a .ssh/id_rsa.
            optional: true        
      workspaces:
        - name: source-ws
          persistentVolumeClaim:
            claimName: bio-poc   
          {{- if eq .Values.sourceVisibility "private" }}                  
        - name: sshkey-ws
          secret:
            secretName: "{{- if eq .Values.gitAuthMode "ssh-auth" }}{{ .Values.gitAuthCredentials }}{{- end }}{{- if eq .Values.gitAuthMode "built-in-ssh" }}{{ .Release.SSH.Credentials }}{{- end }}"
          {{- end }}
  values.yaml: |
    sourceVisibility: "public"
    sampleName: "FA240915059"
  values.schema.json: |
    {
      "properties": {
        "sampleName": {
          "title": "样本名称",
          "description": "样本名称，若不设置，默认则以分析job实例名为样本名称",
          "type": "string"
        },
        "r1FastqFile": {
          "title": "r1FastqFile文件",
          "description": "r1FastqFile文件相对数据集仓库的路径，如：data/r1.fastq.gz",
          "type": "string"
        },
        "r2FastqFile": {
          "title": "r2FastqFile文件",
          "description": "r2FastqFile文件相对数据集仓库的路径，如：subpath/r2.fastq.gz",
          "type": "string"
        },
        "outputDir": {
          "title": "输出目录",
          "description": "分析结果输出目录，如：/tmp",
          "type": "string",
          "x-shipper-ui": {
            "visibleIf":{
              "xxx":"true"
            }
          }          
        },
        "alnTarget": {
          "title": "aln_target",
          "description": "aln_target文件相对数据集仓库的路径，如：data/aln_target.bed",
          "type": "string"
        },                                             
        "sourceUrl": {
          "title": "数据集仓库地址",
          "description": "一个生物分析的所需输入参数数据集仓库git url地址，支持公开仓库和私有仓库",
          "type": "string",
          "x-shipper-ui": {
            "placeholder": "github、gitlab、gitee都可以，只要平台可以顺利访问"
          }
        },
        "sourceRef": {
          "title": "仓库分支",
          "description": "指定数据集仓库的分支、Tag、Sha等",
          "type": "string",
          "x-shipper-ui": {
            "placeholder": "没有指定时，默认为”“，即表示按照仓库设定的默认分支构建"
          }
        },
        "sourceVisibility": {
          "description": "提供的git url仓库地址是一个公开仓库还是私有仓库，公开仓库不需要认证！",
          "title": "数据集仓库可见性",
          "type": "string",
          "enum": [{
              "label": "公开仓库",
              "value": "public"
            },
            {
              "label": "私有仓库",
              "value": "private"
            }
          ]
        },
        "gitAuthMode": {
          "description": "指定私有数据集仓库的认证模式,[内置安全认证]模式下请将企业空间内的key（公钥）导入您的git系统！",
          "title": "代码仓库认证模式",
          "type": "string",
          "enum": [{
              "label": "ssh-auth",
              "value": "ssh-auth"
            },
            {
              "label": "内置安全认证（推荐）",
              "value": "built-in-ssh"
            }
          ],
          "x-shipper-ui": {
            "visibleIf":{
              "sourceVisibility":"private"
            }
          }
        },
        "gitAuthCredentials": {
          "title": "数据集仓库认证凭据",
          "description": "认证凭据是一个带有id_rsa的ssh-key的secret，id_rsa键值对完全由您自定义",
          "type": "string",
          "x-shipper-ui": {
            "placeholder": "在这里输入认证凭据 secret 名称",
            "visibleIf":{
              "sourceVisibility":"private",
              "gitAuthMode":"ssh-auth"
            }
          }
        }        
      },
      "order": [
        "sourceUrl",
        "sourceVisibility",
        "gitAuthMode",
        "gitAuthCredentials",
        "sourceRef",
        "sampleName",
        "r1FastqFile",
        "r2FastqFile",
        "outputDir",
        "alnTarget"
      ],
      "required": [
        "sampleName",
        "alnTarget",
        "sourceUrl",
        "sourceVisibility",
        "gitAuthMode",
        "gitAuthCredentials"
      ],
      "title": "Values",
      "type": "object"
    }                                