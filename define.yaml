apiVersion: v1
kind: ConfigMap
metadata:
  name: bio-qc-sample
  namespace: shipper-platform
  labels:
    shipper.lingbohome.com/managed: "true"
    shipper.lingbohome.com/templated-by: "builder"
    template.shipper.lingbohome.com/version: "0.1.0"
  annotations:
    kubesphere.io/alias-name: 生信分析
    kubesphere.io/creator: system
    kubesphere.io/description: "基于用户输入的样本集分析"
    cert.shipper.lingbohome.com/scope: "oss,ssh"
data:
  template.yaml: |
    apiVersion: tekton.dev/v1
    kind: PipelineRun
    metadata:
      annotations:
        tekton.dev/displayName: Shipper-Bio-QC-Sample
        tekton.dev/pipelines.minVersion: 0.17.0
        tekton.dev/platforms: linux/amd64
        tekton.dev/tags: bio
      generateName: baesd-shipper
      labels:
        app.kubernetes.io/version: '0.3'
        shipper.lingbohome.com/platform: shipper
        shipper.lingbohome.com/useFor: builder
    spec:
      params:
        - name: SOURCE_URL
          value: {{ .Values.sourceUrl }}
        - name: SOURCE_REFERENCE
          value: {{ .Values.sourceRef | default "" | quote }}           
        - name: R1_Fastq_File
          value: {{ .Values.r1FastqFile | default "./R1_Fastq_File" }}
        - name: R2_Fastq_File
          value: {{ .Values.r2FastqFile | default "./R2_Fastq_File" }}                      
        - name: Sample_Name
          value: {{ .Values.sampleName | default .Release.PipelineName | quote }}
        - name: Output_Directory
          value: {{ .Values.outputDir | default "/tmp" | quote }}
        - name: AlnTarget
          value: {{ .Values.alnTarget | quote }}                  
      pipelineSpec:
        description: bio qc sample pipeline..
        params:
          - description: A git repo url.
            name: SOURCE_URL
            type: string
          - default: ''
            description: The branch, tag or SHA to checkout.
            name: SOURCE_REFERENCE
            type: string                    
          - default: ./R1_Fastq_File
            description: R1 fastq file.
            name: R1_Fastq_File
            type: string
          - default: ./R2_Fastq_File
            description: R2 fastq file.
            name: R2_Fastq_File
            type: string
          - description: Sample name.
            name: Sample_Name
            type: string 
          - default: /home
            description: Output directory.
            name: Output_Directory
            type: string
          - name: AlnTarget
            type: string                          
        tasks:
          - name: fetch-from-git
            params:
              - name: url
                value: $(params.SOURCE_URL)
              - name: revision
                value: $(params.SOURCE_REFERENCE)
              - name: sslVerify
                value: 'false'
              - name: subdirectory
                value: '{{ .Release.BuilderName }}/00_inputs/'
            taskRef:
              resolver: bundles
              params:
              - name: bundle
                value: hub.cloud.lingbohome.com/shipper/tkn-artifacts/catalog/builtin:0.1
              - name: name
                value: git-clone
              - name: kind
                value: task            
            workspaces:
              - name: output
                workspace: source-ws
              - name: ssh-directory
                workspace: sshkey-ws        
          - name: bio-qc
            params:
              - name: R1_Fastq_File
                value: $(params.R1_Fastq_File)
              - name: R2_Fastq_File
                value: $(params.R2_Fastq_File)
              - name: Sample_Name
                value: $(params.Sample_Name)
              - name: Output_Directory
                value: $(params.Output_Directory)
            runAfter:
              - fetch-from-git                          
            workspaces:
              - name: source
                workspace: source-ws            
            taskSpec:
              description: qc sample task.
              params:
                - default: ./R1_Fastq_File
                  description: R1 fastq file.
                  name: R1_Fastq_File
                  type: string
                - default: ./R2_Fastq_File
                  description: R2 fastq file.
                  name: R2_Fastq_File
                  type: string
                - description: Sample name.
                  name: Sample_Name
                  type: string 
                - default: /home
                  description: Output directory.
                  name: Output_Directory
                  type: string                                                                       
              results:
                - name: R1_Clean_DIGEST
                  type: string
                - name: R1_Unpaired_DIGEST
                  type: string
                - name: R2_Clean_DIGEST
                  type: string
                - name: R2_Unpaired_DIGEST
                  type: string                                       
              workspaces:
                - description: data source
                  name: source                                                    
              steps:            
                - computeResources: {}
                  env:
                    - name: PARAM_INPUT
                      value: "{{ .Release.BuilderName }}/00_inputs"
                    - name: PARAM_STEP_NAME
                      value: "01_QC"                       
                    - name: PARAM_SUBWORKDIR
                      value: "{{ .Release.BuilderName }}/$(PARAM_STEP_NAME)/$(params.Sample_Name)"                                    
                  image: registry.cn-shanghai.aliyuncs.com/bio-cloud/bioinfo-qc:v0.3.2
                  name: sample-qc
                  args:
                    - '-f$(workspaces.source.path)/$(PARAM_INPUT)/$(params.R1_Fastq_File)'
                    - '-r$(workspaces.source.path)/$(PARAM_INPUT)/$(params.R2_Fastq_File)'
                    - '-p$(params.Sample_Name)' 
                    - '-o$(workspaces.source.path)/$(PARAM_SUBWORKDIR)'                                      
                  script: |
                    #!/usr/bin/env bash
                    set -e

                    while getopts f:r:p:o: opt
                    do
                        case $opt in
                            f)
                            r1_fq=$OPTARG
                            ;;
                            r)
                            r2_fq=$OPTARG
                            ;;
                            p)
                            sampleID=$OPTARG
                            ;;
                            o)
                            echo "output args >>>> ${OPTARG}"
                            outDir=$OPTARG
                            ;;
                        esac
                    done

                    ## 准备qc工作目录及输出目录
                    echo "output >>>> ${outDir}"
                    mkdir -p ${outDir}

                    export TRIMMOMATIC=/usr/local/bin/Trimmomatic-0.36/trimmomatic-0.36.jar
                    export ADAPTER=$(workspaces.source.path)/$PARAM_INPUT/TruSeq3-PE-2.fa
                    
                    echo "*** QC by FastQC-v0.11.5 and Trimmomatic-0.36 ***"
                    echo "Begin at:" `date`
                    $FASTQC -t 8 -o $outDir $r1_fq $r2_fq
                    unzip -d $outDir $outDir/${sampleID}_R1*_fastqc.zip
                    unzip -d $outDir $outDir/${sampleID}_R2*_fastqc.zip
                    cp $outDir/${sampleID}_R1*_fastqc/fastqc_data.txt $outDir/$sampleID.R1.fastqc_data.txt
                    cp $outDir/${sampleID}_R2*_fastqc/fastqc_data.txt $outDir/$sampleID.R2.fastqc_data.txt
                    rm -rf $outDir/${sampleID}_R1*_fastqc $outDir/${sampleID}_R2*_fastqc
                    java -jar $TRIMMOMATIC PE -threads 6 -phred33 $r1_fq $r2_fq $outDir/$sampleID.R1_clean.fq.gz $outDir/$sampleID.R1_unpaired.fq.gz $outDir/$sampleID.R2_clean.fq.gz $outDir/$sampleID.R2_unpaired.fq.gz ILLUMINACLIP:$ADAPTER:2:30:10:8:true LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:72
                    echo "End at:" `date`
                    echo "*** Finished QC by FastQC-v0.11.5 and Trimmomatic-0.36 ***"

                    r1_clean_sha256_hash=sha256:$(sha256sum "$outDir/$sampleID.R1_clean.fq.gz" | awk '{print $1}')
                    r1_unpaired_sha256_hash=sha256:$(sha256sum "$outDir/$sampleID.R1_unpaired.fq.gz" | awk '{print $1}')
                    r2_clean_sha256_hash=sha256:$(sha256sum "$outDir/$sampleID.R2_clean.fq.gz" | awk '{print $1}')
                    r2_unpaired_sha256_hash=sha256:$(sha256sum "$outDir/$sampleID.R2_unpaired.fq.gz" | awk '{print $1}')

                    usehttps={{- .Release.OSS.S3.UseHttps | default "false" }}
                    bucket={{ .Release.Workspace | default "bio-results" }}
                    schema=http

                    if [ "$usehttps" = true ]; then
                        schema=https
                    fi

                    mc alias set oss $schema://{{- .Release.OSS.S3.Endpoint | default "minioserver.example.net" }} {{ .Release.OSS.S3.AccessKey }} {{ .Release.OSS.S3.SecretKey }} 
                    mc mb oss/$bucket  --ignore-existing
                    mc put $outDir/$sampleID.R1_clean.fq.gz oss/$bucket/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/${PARAM_STEP_NAME}/$sampleID/$sampleID.R1_clean.fq.gz
                    mc put $outDir/$sampleID.R1_unpaired.fq.gz oss/$bucket/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/${PARAM_STEP_NAME}/$sampleID/$sampleID.R1_unpaired.fq.gz
                    mc put $outDir/$sampleID.R2_clean.fq.gz oss/$bucket/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/${PARAM_STEP_NAME}/$sampleID/$sampleID.R2_clean.fq.gz
                    mc put $outDir/$sampleID.R2_unpaired.fq.gz oss/$bucket/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/${PARAM_STEP_NAME}/$sampleID/$sampleID.R2_unpaired.fq.gz

                    echo "> bio qc results uploaded..."
                    echo -n "$r1_clean_sha256_hash" | tee "$(results.R1_Clean_DIGEST.path)"
                    echo -n "$r1_unpaired_sha256_hash" | tee "$(results.R1_Unpaired_DIGEST.path)"
                    echo -n "$r2_clean_sha256_hash" | tee "$(results.R2_Clean_DIGEST.path)"
                    echo -n "$r2_unpaired_sha256_hash" | tee "$(results.R2_Unpaired_DIGEST.path)"
                    echo -e ">>>> output files <<<<" 
                    echo -e ">>>> end <<<<" 
          - name: bio-aln
            params:
              - name: Sample_Name
                value: $(params.Sample_Name)
              - name: AlnTarget
                value: $(params.AlnTarget)
            runAfter:
              - bio-qc                          
            workspaces:
              - name: source
                workspace: source-ws            
            taskSpec:
              description: aln sample task.
              params:
                - description: Sample name.
                  name: Sample_Name
                  type: string 
                - name: AlnTarget
                  type: string                                                                       
              results:
                - name: Sort_Bam_DIGEST
                  type: string
                - name: Sort_Bam_Bai_DIGEST
                  type: string
                - name: Target_Bam_DIGEST
                  type: string
                - name: Target_Bam_Bai_DIGEST
                  type: string                                       
              workspaces:
                - description: data source
                  name: source                                                    
              steps:            
                - computeResources: {}
                  env:
                    - name: PARAM_INPUT
                      value: "{{ .Release.BuilderName }}/00_inputs"
                    - name: PARAM_STEP_NAME
                      value: "02_aln"                      
                    - name: PARAM_01QCDIR
                      value: "{{ .Release.BuilderName }}/01_QC/$(params.Sample_Name)"
                    - name: PARAM_SUBWORKDIR
                      value: "{{ .Release.BuilderName }}/$(PARAM_STEP_NAME)/$(params.Sample_Name)"                                        
                  image: registry.cn-shanghai.aliyuncs.com/bio-cloud/bioinfo-aln:v0.2
                  name: sample-aln
                  args:
                    - '-f$(workspaces.source.path)/$(PARAM_01QCDIR)/$(params.Sample_Name).R1_clean.fq.gz'
                    - '-r$(workspaces.source.path)/$(PARAM_01QCDIR)/$(params.Sample_Name).R2_clean.fq.gz'
                    - '-p$(params.Sample_Name)'
                    - '-t$(workspaces.source.path)/$(PARAM_INPUT)/$(params.AlnTarget)'  
                    - '-o$(workspaces.source.path)/$(PARAM_SUBWORKDIR)'                                      
                  script: |
                    #!/usr/bin/env bash
                    set -e

                    while getopts f:r:p:t:o: opt
                    do
                        case $opt in
                            f)
                            r1_fq=$OPTARG
                            ;;
                            r)
                            r2_fq=$OPTARG
                            ;;
                            p)
                            sampleID=$OPTARG
                            ;;
                            t)
                            target=$OPTARG
                            ;;
                            o)
                            outDir=$OPTARG
                            ;;
                        esac
                    done

                    ## 准备aln工作目录及输出目录
                    echo "output >>>> ${outDir}"
                    mkdir -p $outDir

                    ##设置环境变量
                    export SOFT=/data1/workdir/software
                    export SAMTOOLS_1_8=$SOFT/samtools-1.8/bin/samtools
                    export REF="$(workspaces.source.path)/index_files/human_g1k_v37"
                    ######例子
                    ####   sh /home/wangce/workdir/bin/ctDNA_v5/aln_ctDNA.sh  -f /data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/01_QC/202411_CL02080.R1_clean.fq.gz  -r /data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/01_QC/202411_CL02080.R2_clean.fq.gz  -t /home/wangce/workdir/database/humandb/panel/338genes_20210624.bed  -p 202411_CL02080  -o /data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/02_aln  >>/data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/scriptLog/02_aln_202411_CL02080.o  2>>/data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/scriptLog/02_aln_202411_CL02080.e
                    echo "Begin at:" `date`
                    echo "*** Alignment by BWA-0.7.12-r1039 ***"
                    cd $(workspaces.source.path)/index_files
                    # bwa index -p human_g1k_v37 -b 1000000000 -a bwtsw $(workspaces.source.path)/index_files/human_g1k_v37.fasta.gz
                    # bwa index -p human_g1k_v37 $outDir/human_g1k_v37.fasta.gz
                    cd $(workspaces.source.path)
                    bwa mem -R "@RG\tID:$sampleID\tSM:$sampleID\tPL:illumina\tDS:hg19\tCN:clgene" -t 8 -M $REF $r1_fq $r2_fq > $outDir/$sampleID.bam
                    ## bwa mem -R "@RG\tID:$sampleID\tSM:$sampleID\tPL:illumina\tDS:hg19\tCN:clgene" -t 8 -M ./index_files/human_g1k_v37 ./01_QC/FA240915059.R1_clean.fq.gz ./01_QC/FA240915059.R2_clean.fq.gz $r2_fq > ./02_aln/$sampleID.bam
                    echo "*** Finished alignment by BWA-0.7.12-r1039 ***"
                    echo "*** Bam sorting by samtools-v1.8 ***"
                    $SAMTOOLS_1_8 sort -m 4G -@ 8 -T $outDir/$sampleID.sort -o $outDir/$sampleID.sort.bam $outDir/$sampleID.bam
                    if [ -f "$outDir/$sampleID.sort.bam" ];then
                      $SAMTOOLS_0_1_19 index $outDir/$sampleID.sort.bam
                      rm $outDir/$sampleID.bam
                    fi
                    echo "*** Finished sorting bam by samtools-v1.8 ***"
                    echo "*** Target region filter by samtools-v0.1.19 ***"
                    $SAMTOOLS_0_1_19 view -b -@ 8 -q 30 -L $target -o $outDir/$sampleID.target.bam $outDir/$sampleID.sort.bam
                    $SAMTOOLS_0_1_19 index $outDir/$sampleID.target.bam
                    echo "*** Finished target region filter by samtools-v0.1.19 ***"
                    echo "End at:" `date`

                    ls -l $outDir

                    sort_bam_sha256_hash=sha256:$(sha256sum "$outDir/$sampleID.sort.bam" | awk '{print $1}')
                    sort_bam_bai_sha256_hash=sha256:$(sha256sum "$outDir/$sampleID.sort.bam.bai" | awk '{print $1}')
                    target_bam_sha256_hash=sha256:$(sha256sum "$outDir/$sampleID.target.bam" | awk '{print $1}')
                    target_bam_bai_sha256_hash=sha256:$(sha256sum "$outDir/$sampleID.target.bam.bai" | awk '{print $1}')

                    usehttps={{- .Release.OSS.S3.UseHttps | default "false" }}
                    bucket={{ .Release.Workspace | default "bio-poc-data" }}
                    schema=http

                    if [ "$usehttps" = true ]; then
                        schema=https
                    fi

                    mc alias set oss $schema://{{- .Release.OSS.S3.Endpoint | default "minioserver.example.net" }} {{ .Release.OSS.S3.AccessKey }} {{ .Release.OSS.S3.SecretKey }} 
                    mc mb oss/$bucket  --ignore-existing
                    mc put $outDir/$sampleID.sort.bam oss/$bucket/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/${PARAM_STEP_NAME}/$sampleID/$sampleID.sort.bam
                    mc put $outDir/$sampleID.sort.bam.bai oss/$bucket/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/${PARAM_STEP_NAME}/$sampleID/$sampleID.sort.bam.bai
                    mc put $outDir/$sampleID.target.bam oss/$bucket/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/${PARAM_STEP_NAME}/$sampleID/$sampleID.target.bam
                    mc put $outDir/$sampleID.target.bam.bai oss/$bucket/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/${PARAM_STEP_NAME}/$sampleID/$sampleID.target.bam.bai

                    echo "> bio aln results uploaded..."
                    echo -n "$sort_bam_sha256_hash" | tee "$(results.Sort_Bam_DIGEST.path)"
                    echo -n "$sort_bam_bai_sha256_hash" | tee "$(results.Sort_Bam_Bai_DIGEST.path)"
                    echo -n "$target_bam_sha256_hash" | tee "$(results.Target_Bam_DIGEST.path)"
                    echo -n "$target_bam_bai_sha256_hash" | tee "$(results.Target_Bam_Bai_DIGEST.path)"
                    echo -e ">>>> end <<<<"
                - computeResources: {}
                  env:
                    - name: PARAM_INPUT
                      value: "{{ .Release.BuilderName }}/00_inputs"
                    - name: PARAM_STEP_NAME
                      value: "02_aln_post"
                    - name: PARAM_OUTPUT_DIR
                      value: "03_var"                                            
                    - name: PARAM_02ALNDIR
                      value: "{{ .Release.BuilderName }}/02_aln/$(params.Sample_Name)"
                    - name: PARAM_SUBWORKDIR
                      value: "{{ .Release.BuilderName }}/$(PARAM_OUTPUT_DIR)/$(params.Sample_Name)"                                        
                  image: registry.cn-shanghai.aliyuncs.com/bio-cloud/bioinfo-aln:v0.2
                  name: sample-aln-post
                  args:
                    - '-b$(workspaces.source.path)/$(PARAM_02ALNDIR)/$(params.Sample_Name).sort.bam'
                    - '-m$(workspaces.source.path)/$(PARAM_INPUT)/$(params.AlnTarget)'
                    - '-p$(params.Sample_Name)'
                    - '-t$(workspaces.source.path)/$(PARAM_INPUT)/$(params.AlnTarget)'  
                    - '-o$(workspaces.source.path)/$(PARAM_SUBWORKDIR)'                                      
                  script: |
                    #!/usr/bin/env bash
                    set -e

                    while getopts b:t:m:p:o: opt
                    do
                        case $opt in
                            b)
                            bam=$OPTARG
                            ;;
                            t)
                            target=$OPTARG
                            ;;
                            m)
                            medicineDir=$OPTARG
                            ;;
                            p)
                            sampleID=$OPTARG
                            ;;
                            o)
                            outDir=$OPTARG
                            ;;
                        esac
                    done

                    ## 准备aln_post工作目录及输出目录
                    echo "output >>>> ${outDir}"
                    mkdir -p $outDir

                    ##设置环境变量
                    export SOFT=/data1/workdir/software
                    export SAMTOOLS_1_8=$SOFT/samtools-1.8/bin/samtools
                    export REF="$(workspaces.source.path)/index_files/human_g1k_v37.fasta"
                    ###例子
                    ### sh /home/wangce/workdir/bin/ctDNA_v5/snvIndel_calling_ctDNA_v2.sh  -t /data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/02_aln/202411_CL02080.rmdup.target.bam  -l /home/wangce/workdir/database/humandb/panel/338genes_20210624.bed  -c /home/wangce/workdir/database/humandb/ctDNA_report/pon/panel338_Mutect2_2021/vcf/40samples.pon.vcf.gz  -p 202411_CL02080  -o /data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/03_var  >>/data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/scriptLog/03_snvInDel_calling_202411_CL02080.o  2>>/data3/Projects/panel338_2021/240428_A00582_1255_AHWWNGDSX7/scriptLog/03_snvInDel_calling_202411_CL02080.e
                    echo "*** Post alignment process by gencore-v0.14.0, picard-2.20.0 and samtools-v0.1.19 ***"
                    echo "Begin at:" `date`
                    {
                        ##### Generate consensus reads to reduce sequencing noises and remove duplications 
                        $GENCORE -i $bam -o $outDir/$sampleID.rmdup.unsorted.bam -r $REF -a 0.7 -j $outDir/$sampleID.report.json -h $outDir/$sampleID.report.html
                        echo "sort bam ...."
                        ##### Sort bam
                        $SAMTOOLS_1_8 sort -m 4G -@ 4 -T $outDir/$sampleID.rmdup -o $outDir/$sampleID.rmdup.bam $outDir/$sampleID.rmdup.unsorted.bam
                        $SAMTOOLS_1_8 index $outDir/$sampleID.rmdup.bam
                        ##### Remove bam
                        rm $outDir/$sampleID.rmdup.unsorted.bam
                        ##### Target bam
                        $SAMTOOLS_1_8 view -b -@ 4 -L $target -o $outDir/$sampleID.rmdup.target.bam $outDir/$sampleID.rmdup.bam
                        $SAMTOOLS_1_8 index $outDir/$sampleID.rmdup.target.bam
                    } &
                    {
                        ##### Remove duplicate reads
                        java -Xmx16g -jar $PICARD MarkDuplicates I=$bam O=$outDir/$sampleID.sv_rmdup.bam M=$outDir/$sampleID.sv_rmdup.metrix VALIDATION_STRINGENCY=LENIENT REMOVE_DUPLICATES=true
                        $SAMTOOLS_1_8 index $outDir/$sampleID.sv_rmdup.bam
                        ##### Target bam
                        #$SAMTOOLS_1_8 view -b -@ 4 -L $medicineDir -o $outDir/$sampleID.sv_rmdup.sv_target.bam $outDir/$sampleID.sv_rmdup.bam
                        #$SAMTOOLS_1_8 index $outDir/$sampleID.sv_rmdup.sv_target.bam
                    } &
                    wait
                    echo "End at:" `date`
                    echo "*** Finished post alignment process by gencore-v0.14.0, picard-2.20.0 and samtools-v1.8 ***"

                    ls -l $outDir

                    # sort_bam_sha256_hash=sha256:$(sha256sum "$outDir/$sampleID.sort.bam" | awk '{print $1}')
                    # sort_bam_bai_sha256_hash=sha256:$(sha256sum "$outDir/$sampleID.sort.bam.bai" | awk '{print $1}')
                    # target_bam_sha256_hash=sha256:$(sha256sum "$outDir/$sampleID.target.bam" | awk '{print $1}')
                    # target_bam_bai_sha256_hash=sha256:$(sha256sum "$outDir/$sampleID.target.bam.bai" | awk '{print $1}')

                    # usehttps={{- .Release.OSS.S3.UseHttps | default "false" }}
                    # bucket={{ .Release.Workspace | default "bio-poc-data" }}
                    # schema=http

                    # if [ "$usehttps" = true ]; then
                    #     schema=https
                    # fi

                    # mc alias set oss $schema://{{- .Release.OSS.S3.Endpoint | default "minioserver.example.net" }} {{ .Release.OSS.S3.AccessKey }} {{ .Release.OSS.S3.SecretKey }} 
                    # mc mb oss/$bucket  --ignore-existing
                    # mc put $outDir/$sampleID.sort.bam oss/$bucket/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/${PARAM_STEP_NAME}/$sampleID/$sampleID.sort.bam
                    # mc put $outDir/$sampleID.sort.bam.bai oss/$bucket/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/${PARAM_STEP_NAME}/$sampleID/$sampleID.sort.bam.bai
                    # mc put $outDir/$sampleID.target.bam oss/$bucket/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/${PARAM_STEP_NAME}/$sampleID/$sampleID.target.bam
                    # mc put $outDir/$sampleID.target.bam.bai oss/$bucket/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/${PARAM_STEP_NAME}/$sampleID/$sampleID.target.bam.bai

                    # echo "> bio aln results uploaded..."
                    # echo -n "$sort_bam_sha256_hash" | tee "$(results.Sort_Bam_DIGEST.path)"
                    # echo -n "$sort_bam_bai_sha256_hash" | tee "$(results.Sort_Bam_Bai_DIGEST.path)"
                    # echo -n "$target_bam_sha256_hash" | tee "$(results.Target_Bam_DIGEST.path)"
                    # echo -n "$target_bam_bai_sha256_hash" | tee "$(results.Target_Bam_Bai_DIGEST.path)"
                    # echo -e ">>>> end <<<<"
                - computeResources: {}
                  env:
                    - name: PARAM_INPUT
                      value: "{{ .Release.BuilderName }}/00_inputs"
                    - name: PARAM_01QCDIR
                      value: "{{ .Release.BuilderName }}/01_QC/$(params.Sample_Name)"                      
                    - name: PARAM_02ALNDIR
                      value: "{{ .Release.BuilderName }}/02_aln/$(params.Sample_Name)"
                    - name: PARAM_03VARDIR
                      value: "{{ .Release.BuilderName }}/03_var/$(params.Sample_Name)"                                                                   
                    - name: PARAM_SUBWORKDIR
                      value: "{{ .Release.BuilderName }}/$(PARAM_STEP_NAME)/$(params.Sample_Name)"                                    
                  image: registry.cn-shanghai.aliyuncs.com/bio-cloud/bioinfo-qc-statistics:v0.2
                  name: qc-statistics                                     
                  script: |
                    #!/usr/bin/env bash
                    set -e
                    echo  -e "$(params.Sample_Name)\t$(workspaces.source.path)/$PARAM_02ALNDIR/$(params.Sample_Name).sort.bam\t$(workspaces.source.path)/$PARAM_03VARDIR/$(params.Sample_Name).rmdup.bam\t$(workspaces.source.path)/$PARAM_01QCDIR/$(params.Sample_Name).R1.fastqc_data.txt\t$(workspaces.source.path)/$PARAM_01QCDIR/$(params.Sample_Name).R2.fastqc_data.txt" >$(workspaces.source.path)/$PARAM_02ALNDIR/$(params.Sample_Name).bam_fastqc.list

                    perl /usr/local/bin/library_qc_ctDNA.pl  -l $(workspaces.source.path)/$PARAM_02ALNDIR/$(params.Sample_Name).bam_fastqc.list  -b $(workspaces.source.path)/$PARAM_INPUT/$(params.AlnTarget)  -p $(params.Sample_Name)  -o $(workspaces.source.path)/$PARAM_01QCDIR -S $SOFT/samtools-1.8/bin -B $SOFT/bedtools2/bin                                                                                   
        finally:
          - name: artifacts-producer
            params:
              - name: QC_STEP_NAME
                value: "01_QC"
              - name: ALN_STEP_NAME
                value: "02_aln"             
              - name: R1_Clean_DIGEST
                value: "$(tasks.bio-qc.results.R1_Clean_DIGEST)"
              - name: R1_Unpaired_DIGEST
                value: "$(tasks.bio-qc.results.R1_Unpaired_DIGEST)"                
              - name: R2_Clean_DIGEST
                value: "$(tasks.bio-qc.results.R2_Clean_DIGEST)" 
              - name: R2_Unpaired_DIGEST
                value: "$(tasks.bio-qc.results.R2_Unpaired_DIGEST)"
              - name: Sample_Name
                value: "$(params.Sample_Name)"                                                                                                                                       
            taskSpec:
              description: |
                      A simple task that populates artifacts to TaskRun result
              params:
                - name: QC_STEP_NAME
                - name: ALN_STEP_NAME                              
                - name: R1_Clean_DIGEST
                - name: R1_Unpaired_DIGEST
                - name: R2_Clean_DIGEST 
                - name: R2_Unpaired_DIGEST
                - name: Sample_Name                                      
              results:
                - description: artifact info.
                  name: ArtifactInfo
                  type: string       
              steps:
                - name: emitting-artifacts
                  image: registry.cn-shanghai.aliyuncs.com/kube-shipper/bash:5.1.4
                  script: |
                    cat > $(results.ArtifactInfo.path) << EOF
                     {"description":"生物分析结果集","outputs":[{"name":"r1-clean","producer":"qc-analyzer","type":"oss","format":"file","url":"pkg:oss/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.QC_STEP_NAME)/$(params.Sample_Name)/$(params.Sample_Name).R1_clean.fq.gz?endpoint={{ .Release.OSS.S3.Endpoint }}&bucket={{ .Release.Workspace | default "bio-results" }}&usehttps={{- .Release.OSS.S3.UseHttps | default "false" }}","digest":"$(params.R1_Clean_DIGEST)","displayName":"{{ .Release.Workspace | default "bio-results" }}/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.QC_STEP_NAME)/$(params.Sample_Name)/$(params.Sample_Name).R1_clean.fq.gz","description":"$(params.QC_STEP_NAME)"},{"name":"r1-unpaired","producer":"qc-analyzer","type":"oss","format":"file","url":"pkg:oss/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.QC_STEP_NAME)/$(params.Sample_Name)/$(params.Sample_Name).R1_unpaired.fq.gz?endpoint={{ .Release.OSS.S3.Endpoint }}&bucket={{ .Release.Workspace | default "bio-results" }}&usehttps={{- .Release.OSS.S3.UseHttps | default "false" }}","digest":"$(params.R1_Unpaired_DIGEST)","displayName":"{{ .Release.Workspace | default "bio-results" }}/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.QC_STEP_NAME)/$(params.Sample_Name)/$(params.Sample_Name).R1_unpaired.fq.gz","description":"$(params.QC_STEP_NAME)"},{"name":"r2-clean","producer":"qc-analyzer","type":"oss","format":"file","url":"pkg:oss/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.QC_STEP_NAME)/$(params.Sample_Name)/$(params.Sample_Name).R2_clean.fq.gz?endpoint={{ .Release.OSS.S3.Endpoint }}&bucket={{ .Release.Workspace | default "bio-results" }}&usehttps={{- .Release.OSS.S3.UseHttps | default "false" }}","digest":"$(params.R2_Clean_DIGEST)","displayName":"{{ .Release.Workspace | default "bio-results" }}/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.QC_STEP_NAME)/$(params.Sample_Name)/$(params.Sample_Name).R2_clean.fq.gz","description":"$(params.QC_STEP_NAME)"},{"name":"r2-unpaired","producer":"qc-analyzer","type":"oss","format":"file","url":"pkg:oss/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.QC_STEP_NAME)/$(params.Sample_Name)/$(params.Sample_Name).R2_unpaired.fq.gz?endpoint={{ .Release.OSS.S3.Endpoint }}&bucket={{ .Release.Workspace | default "bio-results" }}&usehttps={{- .Release.OSS.S3.UseHttps | default "false" }}","digest":"$(params.R2_Unpaired_DIGEST)","displayName":"{{ .Release.Workspace | default "bio-results" }}/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.QC_STEP_NAME)/$(params.Sample_Name)/$(params.Sample_Name).R2_unpaired.fq.gz","description":"$(params.QC_STEP_NAME)"},{"name":"sort_bam","producer":"aln-analyzer","type":"oss","format":"file","url":"pkg:oss/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.ALN_STEP_NAME)/$(params.Sample_Name)/$(params.Sample_Name).sort.bam?endpoint={{ .Release.OSS.S3.Endpoint }}&bucket={{ .Release.Workspace | default "bio-results" }}&usehttps={{- .Release.OSS.S3.UseHttps | default "false" }}","digest":"$(tasks.bio-aln.results.Sort_Bam_DIGEST)","displayName":"{{ .Release.Workspace | default "bio-results" }}/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.ALN_STEP_NAME)/$(params.Sample_Name)/$(params.Sample_Name).sort.bam","description":"$(params.ALN_STEP_NAME)"},{"name":"sort_bam_bai","producer":"aln-analyzer","type":"oss","format":"file","url":"pkg:oss/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.ALN_STEP_NAME)/$(params.Sample_Name)/$(params.Sample_Name).sort.bam.bai?endpoint={{ .Release.OSS.S3.Endpoint }}&bucket={{ .Release.Workspace | default "bio-results" }}&usehttps={{- .Release.OSS.S3.UseHttps | default "false" }}","digest":"$(tasks.bio-aln.results.Sort_Bam_Bai_DIGEST)","displayName":"{{ .Release.Workspace | default "bio-results" }}/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.ALN_STEP_NAME)/$(params.Sample_Name)/$(params.Sample_Name).sort.bam.bai","description":"$(params.ALN_STEP_NAME)"},{"name":"target_bam","producer":"aln-analyzer","type":"oss","format":"file","url":"pkg:oss/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.ALN_STEP_NAME)/$(params.Sample_Name)/$(params.Sample_Name).target.bam?endpoint={{ .Release.OSS.S3.Endpoint }}&bucket={{ .Release.Workspace | default "bio-results" }}&usehttps={{- .Release.OSS.S3.UseHttps | default "false" }}","digest":"$(tasks.bio-aln.results.Target_Bam_DIGEST)","displayName":"{{ .Release.Workspace | default "bio-results" }}/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.ALN_STEP_NAME)/$(params.Sample_Name)/$(params.Sample_Name).target.bam","description":"$(params.ALN_STEP_NAME)"},{"name":"target_bam_bai","producer":"aln-analyzer","type":"oss","format":"file","url":"pkg:oss/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.ALN_STEP_NAME)/$(params.Sample_Name)/$(params.Sample_Name).target.bam.bai?endpoint={{ .Release.OSS.S3.Endpoint }}&bucket={{ .Release.Workspace | default "bio-results" }}&usehttps={{- .Release.OSS.S3.UseHttps | default "false" }}","digest":"$(tasks.bio-aln.results.Target_Bam_Bai_DIGEST)","displayName":"{{ .Release.Workspace | default "bio-results" }}/{{ .Release.Namespace }}/{{ .Release.BuilderName }}/$(params.ALN_STEP_NAME)/$(params.Sample_Name)/$(params.Sample_Name).target.bam.bai","description":"$(params.ALN_STEP_NAME)"}]}
                    EOF
        results:
          - name: shipper-artifacts
            value: $(finally.artifacts-producer.results.ArtifactInfo)
        workspaces:
          - description: Location where source is stored.
            name: source-ws
          - name: sshkey-ws
            description: An optional workspace that allows providing a .ssh/id_rsa.
            optional: true        
      workspaces:
        - name: source-ws
          persistentVolumeClaim:
            claimName: bio-poc   
          {{- if eq .Values.sourceVisibility "private" }}                  
        - name: sshkey-ws
          secret:
            secretName: "{{- if eq .Values.gitAuthMode "ssh-auth" }}{{ .Values.gitAuthCredentials }}{{- end }}{{- if eq .Values.gitAuthMode "built-in-ssh" }}{{ .Release.SSH.Credentials }}{{- end }}"
          {{- end }}
  values.yaml: |
    sourceVisibility: "public"
    sampleName: "FA240915059"
  values.schema.json: |
    {
      "properties": {
        "sampleName": {
          "title": "样本名称",
          "description": "样本名称，若不设置，默认则以分析job实例名为样本名称",
          "type": "string"
        },
        "r1FastqFile": {
          "title": "r1FastqFile文件",
          "description": "r1FastqFile文件相对数据集仓库的路径，如：data/r1.fastq.gz",
          "type": "string"
        },
        "r2FastqFile": {
          "title": "r2FastqFile文件",
          "description": "r2FastqFile文件相对数据集仓库的路径，如：subpath/r2.fastq.gz",
          "type": "string"
        },
        "outputDir": {
          "title": "输出目录",
          "description": "分析结果输出目录，如：/tmp",
          "type": "string",
          "x-shipper-ui": {
            "visibleIf":{
              "xxx":"true"
            }
          }          
        },
        "alnTarget": {
          "title": "aln_target",
          "description": "aln_target文件相对数据集仓库的路径，如：data/aln_target.bed",
          "type": "string"
        },                                             
        "sourceUrl": {
          "title": "数据集仓库地址",
          "description": "一个生物分析的所需输入参数数据集仓库git url地址，支持公开仓库和私有仓库",
          "type": "string",
          "x-shipper-ui": {
            "placeholder": "github、gitlab、gitee都可以，只要平台可以顺利访问"
          }
        },
        "sourceRef": {
          "title": "仓库分支",
          "description": "指定数据集仓库的分支、Tag、Sha等",
          "type": "string",
          "x-shipper-ui": {
            "placeholder": "没有指定时，默认为”“，即表示按照仓库设定的默认分支构建"
          }
        },
        "sourceVisibility": {
          "description": "提供的git url仓库地址是一个公开仓库还是私有仓库，公开仓库不需要认证！",
          "title": "数据集仓库可见性",
          "type": "string",
          "enum": [{
              "label": "公开仓库",
              "value": "public"
            },
            {
              "label": "私有仓库",
              "value": "private"
            }
          ]
        },
        "gitAuthMode": {
          "description": "指定私有数据集仓库的认证模式,[内置安全认证]模式下请将企业空间内的key（公钥）导入您的git系统！",
          "title": "代码仓库认证模式",
          "type": "string",
          "enum": [{
              "label": "ssh-auth",
              "value": "ssh-auth"
            },
            {
              "label": "内置安全认证（推荐）",
              "value": "built-in-ssh"
            }
          ],
          "x-shipper-ui": {
            "visibleIf":{
              "sourceVisibility":"private"
            }
          }
        },
        "gitAuthCredentials": {
          "title": "数据集仓库认证凭据",
          "description": "认证凭据是一个带有id_rsa的ssh-key的secret，id_rsa键值对完全由您自定义",
          "type": "string",
          "x-shipper-ui": {
            "placeholder": "在这里输入认证凭据 secret 名称",
            "visibleIf":{
              "sourceVisibility":"private",
              "gitAuthMode":"ssh-auth"
            }
          }
        }        
      },
      "order": [
        "sourceUrl",
        "sourceVisibility",
        "gitAuthMode",
        "gitAuthCredentials",
        "sourceRef",
        "sampleName",
        "r1FastqFile",
        "r2FastqFile",
        "outputDir",
        "alnTarget"
      ],
      "required": [
        "sampleName",
        "alnTarget",
        "sourceUrl",
        "sourceVisibility",
        "gitAuthMode",
        "gitAuthCredentials"
      ],
      "title": "Values",
      "type": "object"
    }                                